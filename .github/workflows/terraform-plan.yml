name: Terraform Plan

on:
    pull_request:
        branches:
            - main
        paths:
            - "teams/**"
            - "modules/**"

env:
    TF_VERSION: "1.6.0"

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            teams: ${{ steps.changes.outputs.teams }}
        steps:
            - uses: actions/checkout@v4

            - name: Get changed files
              id: changed-files
              uses: tj-actions/changed-files@v45
              with:
                  files: teams/**

            - name: Detect changed team directories
              id: changes
              run: |
                  # Extract team directories from changed files
                  TEAMS=""
                  for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
                    TEAM=$(echo "$file" | cut -d'/' -f2)
                    if [ -n "$TEAM" ] && [ -d "teams/$TEAM" ]; then
                      TEAMS="$TEAMS $TEAM"
                    fi
                  done

                  # Remove duplicates and format as JSON array
                  UNIQUE_TEAMS=$(echo $TEAMS | tr ' ' '\n' | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
                  echo "Detected changed teams: $UNIQUE_TEAMS"
                  echo "teams=$UNIQUE_TEAMS" >> $GITHUB_OUTPUT

    terraform-plan:
        needs: detect-changes
        runs-on: ubuntu-latest
        if: needs.detect-changes.outputs.teams != '[]' && needs.detect-changes.outputs.teams != ''
        strategy:
            matrix:
                team: ${{ fromJson(needs.detect-changes.outputs.teams) }}
            fail-fast: false

        permissions:
            contents: read
            pull-requests: write
            id-token: write # For Workload Identity Federation

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            # Authenticate to GCP using Workload Identity Federation
            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

            - name: Terraform Init
              id: init
              working-directory: teams/${{ matrix.team }}
              run: terraform init -backend=false # -backend=false for PR checks without state access

            - name: Terraform Validate
              id: validate
              working-directory: teams/${{ matrix.team }}
              run: terraform validate

            - name: Terraform Plan
              id: plan
              working-directory: teams/${{ matrix.team }}
              run: terraform plan -no-color -input=false
              continue-on-error: true

            - name: Comment PR with Plan
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const output = `### Terraform Plan for \`${{ matrix.team }}\` üìã

                      #### Initialization ‚öôÔ∏è \`${{ steps.init.outcome }}\`
                      #### Validation ü§ñ \`${{ steps.validate.outcome }}\`
                      #### Plan üìñ \`${{ steps.plan.outcome }}\`

                      <details><summary>Show Plan</summary>

                      \`\`\`terraform
                      ${{ steps.plan.outputs.stdout }}
                      \`\`\`

                      </details>

                      *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      });

            - name: Terraform Plan Status
              if: steps.plan.outcome == 'failure'
              run: exit 1
