name: Terraform Apply

on:
    push:
        branches:
            - main
        paths:
            - "teams/**"

env:
    TF_VERSION: "1.6.0"

jobs:
    detect-changes:
        runs-on: ubuntu-latest
        outputs:
            teams: ${{ steps.changes.outputs.teams }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 2 # Need previous commit to compare

            - name: Detect changed team directories
              id: changes
              run: |
                  # Find which team directories have changes in this push
                  CHANGED_TEAMS=$(git diff --name-only HEAD~1 HEAD | \
                    grep '^teams/' | \
                    cut -d'/' -f2 | \
                    sort -u | \
                    jq -R -s -c 'split("\n") | map(select(length > 0))')
                  echo "Detected changed teams: $CHANGED_TEAMS"
                  echo "teams=$CHANGED_TEAMS" >> $GITHUB_OUTPUT

    terraform-apply:
        needs: detect-changes
        runs-on: ubuntu-latest
        if: needs.detect-changes.outputs.teams != '[]' && needs.detect-changes.outputs.teams != ''
        strategy:
            matrix:
                team: ${{ fromJson(needs.detect-changes.outputs.teams) }}
            fail-fast: false

        permissions:
            contents: read
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}

            - name: Terraform Init
              working-directory: teams/${{ matrix.team }}
              run: terraform init

            - name: Terraform Apply
              working-directory: teams/${{ matrix.team }}
              run: terraform apply -auto-approve -input=false
